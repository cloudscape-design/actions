name: release

on:
  workflow_call:
    inputs:
      publish-packages:
        description: Comma-separated list of sub-folders to publish
        type: string
        required: false
      skip-test:
        type: boolean
        description: Skip tests
        required: false
        default: false

permissions:
  id-token: write
  contents: read

env:
  # Disable Husky in CI
  # https://typicode.github.io/husky/how-to.html#ci-server-and-docker
  HUSKY: 0

jobs:
  release:
    concurrency: release-${{ github.ref }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - run: npm install
      - run: npm run build
      - run: npm run test
        if: ${{ inputs.skip-test == false }}
      - name: Upload release artifacts
        id: upload-release
        uses: actions/upload-artifact@v4
        with:
          name: release
          path: lib

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_CODEARTIFACT_ROLE }}
          aws-region: us-west-2
      - name: Run CodeBuild
        uses: aws-actions/aws-codebuild-run-build@v1
        with:
          project-name: Importer-v2
          disable-source-override: true
          hide-cloudwatch-logs: true
          env-vars-for-codebuild: |
            GITHUB_ARTIFACT_ID,
            GITHUB_REPOSITORY_NAME,
            GITHUB_COMMIT_MESSAGE,
            GITHUB_TOKEN
        env:
          GITHUB_ARTIFACT_ID: ${{ steps.upload-release.outputs.artifact-id }}
          GITHUB_REPOSITORY_NAME: ${{ github.event.repository.name }}
          GITHUB_COMMIT_MESSAGE: ${{ github.event.commits[0].message }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

